FROM centos:8 AS builder

RUN dnf -y install \
    --setopt=deltarpm=0 \
    --setopt=install_weak_deps=false \
    --setopt=tsflags=nodocs \
    git \
    golang \
    make \
    && dnf clean all

ENV OPM_SRC_4_6="/src/4.6"
ENV OPM_TAG_4_6="v1.13.8"
ENV OPM_SRC_4_5="/src/4.5"
ENV OPM_TAG_4_5="v1.12.8"

RUN git clone https://github.com/operator-framework/operator-registry $OPM_SRC_4_6 && \
    (cd $OPM_SRC_4_6 && git checkout $OPM_TAG_4_6 && make build) && \
    cp $OPM_SRC_4_6/bin/opm /usr/bin/opmv4.6

RUN git clone https://github.com/operator-framework/operator-registry $OPM_SRC_4_5 && \
    (cd $OPM_SRC_4_5 && git checkout $OPM_TAG_4_5 && make build) && \
    cp $OPM_SRC_4_5/bin/opm /usr/bin/opmv4.5

FROM centos:8
LABEL maintainer="Red Hat - EXD"

WORKDIR /src
# Install podman 1.7.0 from Fedora 30 as a workaround for
# https://bugzilla.redhat.com/show_bug.cgi?id=1801874
RUN dnf -y install \
    --setopt=deltarpm=0 \
    --setopt=install_weak_deps=false \
    --setopt=tsflags=nodocs \
    buildah \
    gcc \
    krb5-devel \
    https://kojipkgs.fedoraproject.org/packages/podman/1.7.0/3.fc30/x86_64/podman-1.7.0-3.fc30.x86_64.rpm \
    https://kojipkgs.fedoraproject.org/packages/runc/1.0.0/93.dev.gitb9b6cc6.fc30/x86_64/runc-1.0.0-93.dev.gitb9b6cc6.fc30.x86_64.rpm \
    python3-devel \
    python3-pip \
    skopeo \
    && dnf clean all

COPY --from=builder /usr/bin/opmv4.5 /usr/bin/opmv4.5
COPY --from=builder /usr/bin/opmv4.6 /usr/bin/opmv4.6
ADD https://github.com/estesp/manifest-tool/releases/download/v1.0.0/manifest-tool-linux-amd64 /usr/bin/manifest-tool
RUN chmod +x /usr/bin/manifest-tool
COPY . .
RUN pip3 install -r requirements.txt --no-deps --require-hashes
RUN pip3 install . --no-deps
CMD ["/bin/celery-3", "-A", "iib.workers.tasks", "worker", "--loglevel=info"]
